name: Release

on:
  release:
    types: [ prereleased, released ]

jobs:
  release:
    name: Publish Plugin
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 21

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Set Version
        shell: bash
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          # Strip leading 'v' if present
          VERSION="${VERSION#v}"
          sed -i "s/^pluginVersion=.*/pluginVersion=$VERSION/" gradle.properties

      - name: Patch Changelog
        run: JAVA_HOME=$JAVA_HOME_21_X64 ./gradlew --no-configuration-cache patchChangelog

      - name: Publish Plugin
        env:
          PUBLISH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
          CERTIFICATE_CHAIN: ${{ secrets.CERTIFICATE_CHAIN }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          PRIVATE_KEY_PASSWORD: ${{ secrets.PRIVATE_KEY_PASSWORD }}
        run: JAVA_HOME=$JAVA_HOME_21_X64 ./gradlew --no-configuration-cache publishPlugin

      - name: Upload Release Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} build/distributions/*.zip

      - name: Create Pull Request for Changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          BRANCH="changelog-update-$VERSION"
          git config user.email "action@github.com"
          git config user.name "GitHub Actions"
          git checkout -b "$BRANCH"
          git add CHANGELOG.md
          git commit -m "docs: update changelog for $VERSION"
          git push origin "$BRANCH"
          gh pr create \
            --title "Changelog update - $VERSION" \
            --body "Automated changelog update for version $VERSION." \
            --base master \
            --head "$BRANCH"
